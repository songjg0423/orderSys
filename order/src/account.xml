<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="Account">
	<resultMap id="result" class="java.util.HashMap">
		<result property="NAME" column="NAME" jdbcType="VARCHAR"/>
		<result property="ID" column="ID" jdbcType="VARCHAR"/>
	</resultMap>

	<select id="getTableInf" resultMap="result" parameterClass="java.util.Map">
		select NAME,ID from test where id=#id#
    </select>
    
    <resultMap id="userInf" class="java.util.HashMap">		
        <result property="userseq" column="userseq" />
		<result property="userid" column="USERID" />
		<result property="password" column="PASSWORD"/>
		<result property="role" column="role" />
	</resultMap>
    
    <select id="queryUserInfByUserId" resultMap="userInf" parameterClass="java.util.Map">
        select userseq,userid,password,role from tbuser where userid=#username#
    </select>
    
    <update id="updateUserPwd" parameterClass="java.util.Map">
        update tbuser set password=#newPassword# where userseq=#userseq#
    </update>
    
    <resultMap id="roomInf" class="java.util.HashMap">		
        <result property="roomseq" column="roomseq" />
		<result property="id" column="id" />
		<result property="roomlevel" column="roomlevel"/>
		<result property="roomtype" column="roomtype" />
		<result property="path" column="path" />
		<result property="description" column="description" />
		<result property="dayprice" column="dayprice" />
		<result property="hourprice" column="hourprice" />
	</resultMap>
	<resultMap id="roomInf2" class="java.util.HashMap">		
        <result property="roomseq" column="roomseq" />
		<result property="id" column="id" />
		<result property="roomlevel" column="roomlevel"/>
		<result property="roomtype" column="roomtype" />
		<result property="path" column="path" />
		<result property="description" column="description" />
	</resultMap>
    <select id="qryRoomById" resultMap="roomInf" parameterClass="java.util.Map">
        select roomseq,id,roomlevel,roomtype,path,description from room where id=#id#
    </select>
    
    <insert id="insertRoom" parameterClass="java.util.Map">
    	insert into room (id,roomlevel,roomtype,path,description,stt) values (#id#,#roomLevel#,#roomType#,#path#,#description#,'3')
    	<selectKey keyProperty="ID" resultClass="Integer">SELECT @@IDENTITY AS ID
    	</selectKey>
    </insert>
    
    <insert id="insertDayPrice" parameterClass="java.util.Map">
    	insert into roomprice (roomseq,pricetype,price,discount) values (#meetingroomseq#,'2',#dayPrice#,1)
    </insert>
    
    <insert id="insertHourPrice" parameterClass="java.util.Map">
    	insert into roomprice (roomseq,pricetype,price,discount) values (#meetingroomseq#,'1',#hourPrice#,1)
    </insert>
    
    <select id="qryRoomList" resultMap="roomInf" parameterClass="java.util.Map">
        select a.roomSeq,a.id,a.roomlevel,a.roomtype,a.path,a.description,(select b.price from roomprice b where a.roomseq=b.roomseq and b.pricetype='2') as dayprice,
        (select c.price from roomprice c where a.roomseq=c.roomseq and c.pricetype='1') as hourprice from room a where 1=1
        <isNotEmpty property="id"> and id=#id#</isNotEmpty>
        <isNotEmpty property="roomLevel"> and roomlevel=#roomLevel#</isNotEmpty>
        <isNotEmpty property="roomType"> and roomtype=#roomType#</isNotEmpty>
    </select>
    
    <delete id="deleteRoomByRoomseq" parameterClass="java.util.Map">
        delete from room where roomseq=#roomseq#
    </delete>
    
    <select id="queryRoomInfByRoomseq" resultMap="roomInf" parameterClass="java.util.Map">
        select a.roomseq,a.id,a.roomlevel,a.roomtype,a.path,a.description,(select b.price from roomprice b where a.roomseq=b.roomseq and b.pricetype='2') as dayprice,
        (select c.price from roomprice c where a.roomseq=c.roomseq and c.pricetype='1') as hourprice from room a where a.roomseq=#roomseq#
    </select>
    
    <update id="upateRoomInf" parameterClass="java.util.Map">
    	update room set id=#id#,roomlevel=#roomLevel#,roomtype=#roomType#,path=#path#,description=#description# where roomseq=#roomseq#
    </update>
    <update id="updateDayPrice" parameterClass="java.util.Map">
    	update roomprice set price=#dayprice# where roomseq=#roomseq# and pricetype='2'
    </update>
    <update id="updateHourPrice" parameterClass="java.util.Map">
    	update roomprice set price=#hourprice# where roomseq=#roomseq# and pricetype='1'
    </update>
    
    <select id="qryAvaRoom" resultMap="roomInf2" parameterClass="java.util.Map">
        select a.roomseq,a.id,a.roomlevel,a.roomtype,a.path,a.description from room a where 1=1 
        <isNotEmpty property="id"> and id=#id#</isNotEmpty>
        <isNotEmpty property="roomLevel"> and roomlevel=#roomLevel#</isNotEmpty>
        <isNotEmpty property="roomType"> and roomtype=#roomType#</isNotEmpty>
        and not exists (select 1 from meeting b where a.roomseq=b.roomseq and b.stt in ('1','2') and ((b.starttime &lt;= #starttime# and b.endtime &gt;= #starttime#) or (b.endtime &gt;= #endtime# and b.starttime &lt;= #endtime#) or (b.starttime&gt;=#starttime# and b.endtime&lt;=#endtime#)))
    </select>
    
    <select id="qryChangeAvaRoom" resultMap="roomInf2" parameterClass="java.util.Map">
        select a.roomseq,a.id,a.roomlevel,a.roomtype,a.path,a.description from room a where 1=1 
        <isNotEmpty property="id"> and id=#id#</isNotEmpty>
        <isNotEmpty property="roomLevel"> and roomlevel=#roomLevel#</isNotEmpty>
        <isNotEmpty property="roomType"> and roomtype=#roomType#</isNotEmpty>
        and not exists (select 1 from meeting b where b.meetingseq!=#meetingseq# and a.roomseq=b.roomseq and b.stt in ('1','2') and ((b.starttime &lt;= #starttime# and b.endtime &gt;= #starttime#) or (b.endtime &gt;= #endtime# and b.starttime &lt;= #endtime#) or (b.starttime&gt;=#starttime# and b.endtime&lt;=#endtime#)))
    </select>
    
    <resultMap id="price" class="java.util.HashMap">		
        <result property="price" column="price" />
		<result property="discount" column="discount" />
	</resultMap>
    <select id="qryPrice" resultMap="price" parameterClass="java.util.Map">
    	select price,discount from roomprice where roomseq=#roomseq# and pricetype=#pricetype#
    </select>
    
    <insert id="insertMeeting" parameterClass="java.util.Map">
        insert into meeting (roomseq,percount,stt,starttime,endtime,price,subscription,bookername,bookerphone) 
        values (#roomseq#,#percount#,'1',#starttime#,#endtime#,#price#,#subscription#,#bookername#,#bookerphone#)
    	<selectKey keyProperty="ID" resultClass="Integer">SELECT @@IDENTITY AS ID
    	</selectKey>
    </insert>
    
    <insert id="insertpeople" parameterClass="java.util.Map">
        insert into people (meetingseq,cellphone,name,cardid,stt) values (#meetingseq#,#cellphone#,#name#,#cardid#,'1')
    </insert>

	<resultMap class="java.util.HashMap" id="meetingInf">
	    <result property="meetingseq" column="meetingseq" />
		<result property="percount" column="percount" />
		<result property="meetingstt" column="meetingstt" />
		<result property="starttime" column="starttime" />
		<result property="endtime" column="endtime" />
		<result property="price" column="price" />
		<result property="subscription" column="subscription" />
		<result property="bookername" column="bookername" />
		<result property="bookerphone" column="bookerphone" />
		<result property="roomid" column="roomid" />
	</resultMap>
	<resultMap class="java.util.HashMap" id="personInf">
	    <result property="cellphone" column="cellphone" />
		<result property="name" column="name" />
		<result property="cardid" column="cardid" />
		<result property="peopleseq" column="peopleseq" />
	</resultMap>
	<select id="qrymeeting" resultMap="meetingInf" parameterClass="java.util.Map">
		select a.meetingseq,a.percount as percount,a.stt as meetingstt,a.starttime as starttime,a.endtime as endtime,a.price as price,a.subscription as subscription,a.bookername as bookername,a.bookerphone as bookerphone,b.id as roomid from meeting a,room b where a.roomseq=b.roomseq
		<isNotEmpty property="id"> and b.id=#id#</isNotEmpty>
		<isNotEmpty property="bookername"> and a.bookername=#bookername#</isNotEmpty>
		<isNotEmpty property="meetingstt"> and a.stt=#meetingstt#</isNotEmpty>
		<isNotEmpty property="starttime"> and a.starttime=#starttime#</isNotEmpty>
		<isNotEmpty property="endtime"> and a.endtime=#endtime#</isNotEmpty>
	</select>
	
	<update id="cancelMeeting" parameterClass="java.util.Map">
    	update meeting set stt='4' where meetingseq=#meetingseq#
    </update>
    
    <select id="qryMeetingBySeq" resultMap="meetingInf" parameterClass="java.util.Map">
		select a.meetingseq,a.percount as percount,a.stt as meetingstt,a.starttime as starttime,a.endtime as endtime,a.price as price,a.subscription as subscription,a.bookername as bookername,a.bookerphone as bookerphone,b.id as roomid from meeting a,room b where a.roomseq=b.roomseq
		 and a.meetingseq=#meetingseq#
	</select>
	
	<select id="qryMeetingPeople" resultMap="personInf" parameterClass="java.util.Map">
		select cellphone,name,cardid,peopleseq from people where meetingseq=#meetingseq#
	</select>
	
	<update id="changeRoom" parameterClass="java.util.Map">
    	update meeting set roomseq=#targetseq#,price=#price#,starttime=#starttime# where meetingseq=#srcseq#
    </update>
    
    <update id="deletePeople" parameterClass="java.util.Map">
    	delete from people where peopleseq=#peopleseq#
    </update>
    
    <update id="updatePersonCount" parameterClass="java.util.Map">
    	update meeting set percount=percount-1 where meetingseq=#meetingseq#
    </update>
    
    <update id="updatePersonCount1" parameterClass="java.util.Map">
    	update meeting set percount=percount+1 where meetingseq=#meetingseq#
    </update>
    
    <resultMap id="testId" class="java.util.HashMap">		
        <result property="id" column="id" />
	</resultMap>
    
    <select id="qryTestId" resultMap="testId" parameterClass="java.util.Map">
    	select id from test;
    </select>
    
    <update id="updateTestId" parameterClass="java.util.Map">
    	update test set id=#id#
    </update>
</sqlMap>
